<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sorek Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --border: #30363d; --accent: #58a6ff; --text: #c9d1d9; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        /* AUTH */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: var(--panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); width: 300px; text-align: center; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #010409; border: 1px solid var(--border); color: white; border-radius: 6px; }

        /* PANELS */
        #sidebar-left { width: 260px; border-right: 1px solid var(--border); background: #010409; padding: 15px; }
        #main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        #sidebar-right { width: 300px; border-left: 1px solid var(--border); background: #010409; display: flex; flex-direction: column; }

        /* PAINT */
        #paint-area { width: 100%; max-width: 700px; text-align: center; }
        canvas { background: white; border-radius: 8px; cursor: crosshair; touch-action: none; width: 100%; height: 450px; }

        /* CHAT */
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        .msg { margin-bottom: 8px; background: var(--panel); padding: 8px; border-radius: 6px; }
        #chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; }

        /* GAMES */
        .game-overlay { display: none; position: absolute; top: 50px; background: var(--bg); border: 2px solid var(--accent); padding: 20px; border-radius: 15px; z-index: 100; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 240px; }
        .cell { width: 75px; height: 75px; background: var(--panel); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; background: var(--accent); color: white; font-weight: bold; }
        .btn-defi { padding: 4px 8px; font-size: 12px; }
        
        /* MODALE */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        .modal-box { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="auth-card">
            <h2 style="color:var(--accent)">SOREK HUB</h2>
            <input id="user" placeholder="Pseudo">
            <input id="pass" type="password" placeholder="Mot de passe">
            <button class="btn" style="width:100%" onclick="auth('login')">CONNEXION</button>
            <p style="font-size:11px; cursor:pointer" onclick="auth('reg')">Cr√©er un compte</p>
        </div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3 id="m-title"></h3>
            <div id="m-btns" style="display:flex; gap:10px; margin-top:15px"></div>
        </div>
    </div>

    <div id="sidebar-left">
        <h3 id="my-name">Chargement...</h3>
        <p style="font-size:12px; color:var(--accent)">üèÜ Victoires: <span id="my-wins">0</span></p>
        <hr style="border:0; border-top:1px solid var(--border)">
        <h4 style="color:#8b949e">EN LIGNE</h4>
        <div id="user-list"></div>
    </div>

    <div id="main-content">
        <div id="v-home">
            <div id="paint-area">
                <h3>üé® Paint Public (Dessinez ici !)</h3>
                <canvas id="canvas"></canvas>
                <div style="margin-top:10px">
                    <button class="btn" style="background:#da3633" onclick="ctx.clearRect(0,0,canvas.width,canvas.height)">Tout effacer</button>
                </div>
            </div>
        </div>

        <div id="v-morpion" class="game-overlay">
            <h3 id="m-status">Morpion vs ?</h3>
            <div class="grid" id="tic-grid"></div>
            <button class="btn" style="margin-top:15px; width:100%; background:#da3633" onclick="quit()">Quitter</button>
        </div>
        
        <div id="v-cw" class="game-overlay">
            <h3>‚ö° Click War !</h3>
            <h1 id="cw-timer">10</h1>
            <button id="cw-btn" style="width:150px; height:150px; border-radius:50%; background:red; color:white; font-weight:bold; font-size:20px" onclick="cwHit()">TAPPE !</button>
            <p>Ton score: <span id="my-cw">0</span></p>
        </div>
    </div>

    <div id="sidebar-right">
        <div style="padding:15px; border-bottom:1px solid var(--border)"><b>üí¨ TCHAT GLOBAL</b></div>
        <div id="chat-msgs"></div>
        <div id="chat-input-area">
            <input id="chat-in" placeholder="Message..." style="margin:0; flex:1">
            <button class="btn" onclick="sendMsg()" style="margin-left:5px">‚û§</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = "", myWins = 0, myRoom = null, myTurn = false, cwScore = 0, timer = 0;

        // AUTH
        function auth(mode) {
            const u = document.getElementById('user').value, p = document.getElementById('pass').value;
            socket.emit(mode === 'reg' ? 'register' : 'login_attempt', {pseudo: u, pw: p});
        }
        socket.on('auth_res', d => alert(d.msg));
        socket.on('login_success', d => {
            myName = d.pseudo; myWins = d.wins;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('my-name').innerText = myName;
            document.getElementById('my-wins').innerText = myWins;
            initPaint();
        });

        // USERS
        socket.on('update_users', list => {
            let h = "";
            for(let id in list) {
                if(id === socket.id) continue;
                h += `<div class="msg" style="display:flex; justify-content:space-between; align-items:center">
                    <span>${list[id].pseudo}</span>
                    <button class="btn btn-defi" onclick="defi('${id}')">‚öîÔ∏è</button>
                </div>`;
            }
            document.getElementById('user-list').innerHTML = h;
        });

        // DEFI
        function defi(id) {
            const g = confirm("OK pour Morpion, Annuler pour ClickWar") ? "Morpion" : "CW";
            socket.emit('envoyer_defi', {target_id: id, game_type: g});
        }
        socket.on('reception_defi', d => {
            document.getElementById('m-title').innerText = `${d.from_name} te d√©fie !`;
            const div = document.getElementById('m-btns'); div.innerHTML = "";
            const b1 = document.createElement('button'); b1.innerText = "ACCEPTER"; b1.className = "btn";
            b1.onclick = () => { socket.emit('accepter_defi', {challenger_id: d.from_id, game: d.game}); document.getElementById('modal').style.display='none'; };
            const b2 = document.createElement('button'); b2.innerText = "REFUSER"; b2.className = "btn"; b2.style.background = "red";
            b2.onclick = () => document.getElementById('modal').style.display='none';
            div.append(b1, b2); document.getElementById('modal').style.display = 'flex';
        });

        // JEUX
        socket.on('start_game', d => {
            myRoom = d.room; myTurn = (d.role === 'p1');
            if(d.game === "Morpion") {
                document.getElementById('v-morpion').style.display = 'block';
                document.getElementById('m-status').innerText = `Morpion vs ${d.opp}`;
                initTic();
            } else {
                document.getElementById('v-cw').style.display = 'block';
                initCW();
            }
        });

        function initTic() {
            const g = document.getElementById('tic-grid'); g.innerHTML = "";
            for(let i=0; i<9; i++) {
                const c = document.createElement('div'); c.className = 'cell';
                c.onclick = () => {
                    if(!myTurn || c.innerText) return;
                    c.innerText = "X"; myTurn = false;
                    socket.emit('game_action', {idx: i});
                };
                g.appendChild(c);
            }
        }
        socket.on('game_update', d => {
            const cells = document.querySelectorAll('.cell');
            if(cells[d.idx]) { cells[d.idx].innerText = "O"; myTurn = true; }
        });

        function initCW() {
            cwScore = 0; timer = 10;
            const itv = setInterval(() => {
                timer--; document.getElementById('cw-timer').innerText = timer;
                if(timer <= 0) { clearInterval(itv); quit(); }
            }, 1000);
        }
        function cwHit() { if(timer > 0) { cwScore++; document.getElementById('my-cw').innerText = cwScore; } }

        function quit() { 
            socket.emit('quit_game');
            document.getElementById('v-morpion').style.display = 'none';
            document.getElementById('v-cw').style.display = 'none';
        }
        socket.on('opp_left', () => { alert("L'adversaire est parti !"); quit(); });

        // PAINT
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        function initPaint() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            let drawing = false;
            const draw = (e) => {
                if(!drawing) return;
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - r.left;
                const y = (e.clientY || e.touches[0].clientY) - r.top;
                ctx.lineTo(x, y); ctx.stroke();
                socket.emit('draw_data', {x, y});
            };
            canvas.onmousedown = (e) => { drawing=true; ctx.beginPath(); };
            canvas.onmousemove = draw;
            window.onmouseup = () => drawing=false;
            canvas.ontouchstart = (e) => { drawing=true; ctx.beginPath(); };
            canvas.ontouchmove = draw;
        }
        socket.on('draw_remote', d => { ctx.lineTo(d.x, d.y); ctx.stroke(); });

        // CHAT
        function sendMsg() {
            const i = document.getElementById('chat-in');
            if(i.value) { socket.emit('chat_msg', {m: i.value}); i.value = ""; }
        }
        socket.on('new_msg', d => {
            const div = document.createElement('div'); div.className = "msg";
            div.innerHTML = `<b style="color:var(--accent)">${d.u}:</b> ${d.m}`;
            const box = document.getElementById('chat-msgs'); box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });
    </script>
</body>
</html>
