<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sorek Casino & Clicker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --bg: #101010; --panel: #1a1a1a; --accent: #ffd700; --text: #fff; --green: #4caf50; --red: #f44336; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { background: var(--bg); color: var(--text); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

        /* TOAST NOTIFICATIONS (Meilleures popups) */
        #toast-container { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(30,30,30,0.95); color: #fff; padding: 12px 20px; border-radius: 25px; margin-bottom: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); opacity: 0; transform: translateY(-20px); transition: 0.3s; border: 1px solid #333; font-weight: bold; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: var(--green); color: var(--green); }
        .toast.error { border-color: var(--red); color: var(--red); }

        /* HEADER */
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-top: env(safe-area-inset-top, 20px); }
        .badge { background: #333; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; color: var(--accent); }

        /* MAIN */
        main { flex: 1; overflow-y: auto; position: relative; }
        .view { display: none; padding: 20px; animation: fadeUp 0.3s ease-out; height: 100%; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        /* BUTTON CLICKER */
        #clicker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%; }
        #btn-clicker { 
            width: 180px; height: 180px; border-radius: 50%; 
            background: radial-gradient(circle, #2a2a2a, #000); 
            border: 6px solid var(--accent); font-size: 5rem; 
            cursor: pointer; box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            transition: transform 0.05s; display: flex; align-items: center; justify-content: center;
        }
        #btn-clicker:active { transform: scale(0.92); border-color: #fff; }
        .pulse-anim { animation: pulse 0.5s; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);} 70% {box-shadow: 0 0 0 20px rgba(0, 0, 0, 0);} 100% {box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);} }

        /* CASINO */
        .slot-machine { background: #000; padding: 20px; border-radius: 20px; border: 4px solid var(--accent); text-align: center; margin-top: 30px; box-shadow: inset 0 0 20px #000; }
        .slots-window { display: flex; justify-content: center; gap: 10px; font-size: 3.5rem; background: #111; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; overflow: hidden; height: 100px; align-items: center; }
        .slot-col { width: 60px; text-align: center; }

        /* UI ELEMENTS */
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:active { transform: scale(0.98); background: #e6c200; }
        .btn-red { background: var(--red); color: white; }
        
        input { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; margin-bottom: 10px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--accent); }

        /* NAVBAR */
        nav { height: 75px; background: var(--panel); border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { text-align: center; font-size: 0.7rem; color: #666; transition: 0.2s; flex: 1; }
        .nav-item i { display: block; font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); transform: translateY(-3px); }

        /* AUTH */
        #auth-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-box { width: 100%; max-width: 350px; background: #1a1a1a; padding: 30px; border-radius: 20px; border: 1px solid var(--accent); text-align: center; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="auth-overlay">
        <div class="auth-box">
            <h1 style="color:var(--accent); margin-top:0">SOREK CASINO</h1>
            <p id="auth-err" style="color:var(--red); font-size:0.9rem;"></p>
            <input id="u" placeholder="Pseudo">
            <input id="p" type="password" placeholder="Mot de passe">
            <button class="btn btn-primary" onclick="auth('login')">JOUER</button>
            <button class="btn" style="background:transparent; color:var(--accent); border:1px solid var(--accent)" onclick="auth('register')">CR√âER COMPTE</button>
        </div>
    </div>

    <header>
        <div>
            <div class="badge" id="rank-badge">Vagabond</div>
            <div style="font-size:1.4rem; font-weight:bold; margin-top:2px;"><span id="score-val">0</span> üí∞</div>
        </div>
        <div style="text-align:right">
            <div style="font-size:0.8rem; color:#888;">Guilde</div>
            <div style="color:var(--accent); font-weight:bold;" id="guild-tag">Aucune</div>
        </div>
    </header>

    <main>
        <div id="view-clicker" class="view active">
            <div id="clicker-container">
                <button id="btn-clicker" onmousedown="clickAction()">üëÜ</button>
                <div style="margin-top:20px; text-align:center; width:100%">
                    <div id="relative-lb-box" style="margin-bottom:20px; font-size:0.9rem; color:#888; background:#151515; padding:10px; border-radius:10px; max-width:300px; margin: 0 auto 20px auto;">
                        Jouez pour voir le classement...
                    </div>
                    <button class="btn btn-primary" style="max-width:300px" onclick="buyUpgrade()">
                        AM√âLIORER <br><small style="font-weight:normal">Co√ªt: <span id="cost-val">100</span></small>
                    </button>
                </div>
            </div>
        </div>

        <div id="view-casino" class="view">
            <h2 style="text-align:center; color:var(--accent)">JACKPOT SLOTS</h2>
            <div class="slot-machine">
                <div class="slots-window">
                    <div class="slot-col" id="s1">üçí</div>
                    <div class="slot-col" id="s2">üçí</div>
                    <div class="slot-col" id="s3">üçí</div>
                </div>
                <p style="color:#888; font-size:0.9rem;">Mise: 500 üí∞ | Jackpot: x50</p>
                <button class="btn btn-primary" onclick="spinCasino()" id="btn-spin">TOURNER (500)</button>
            </div>
            <div id="casino-result" style="text-align:center; margin-top:20px; font-weight:bold; height:20px;"></div>
        </div>

        <div id="view-social" class="view">
            <h3 style="text-align:center">SOCIAL HUB</h3>
            <p style="text-align:center; color:#666">Chat et Amis bient√¥t ici...</p>
        </div>
    </main>

    <nav>
        <div class="nav-item active" onclick="switchView('clicker', this)"><i>‚ö°</i>Click</div>
        <div class="nav-item" onclick="switchView('casino', this)"><i>üé∞</i>Casino</div>
        <div class="nav-item" onclick="switchView('social', this)"><i>üë•</i>Social</div>
    </nav>

    <script>
        const socket = io();
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let myMult = 1;

        // --- SOUND ENGINE (Synth√©tiseur) ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'click') {
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1800, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'spin') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(500, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        // --- AUTH ---
        function auth(t) {
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            if(u && p) socket.emit('login_action', {pseudo: u, password: p, type: t});
        }
        socket.on('auth_error', m => showToast(m, 'error'));
        socket.on('login_ok', d => {
            document.getElementById('auth-overlay').style.display = 'none';
            updateUI(d);
            showToast(`Bienvenue ${d.pseudo} !`, 'success');
        });

        // --- UI & LOGIC ---
        let emojis = ["üëÜ", "üëä", "üî•", "üíé", "üëë", "üöÄ", "ü™ê", "‚ö°", "üê≤", "ü§ñ"];

        function updateUI(d) {
            document.getElementById('score-val').innerText = d.clicks;
            document.getElementById('cost-val').innerText = d.mult * 100;
            document.getElementById('guild-tag').innerText = d.guild || "Aucune";
            document.getElementById('rank-badge').innerText = d.rank;
            myMult = d.mult;

            // Fix Emoji Logic
            let scoreInt = parseInt(d.clicks);
            let idx = Math.floor(scoreInt / 500) % emojis.length;
            document.getElementById('btn-clicker').innerText = emojis[idx];
        }

        socket.on('update_full_state', d => updateUI(d));
        socket.on('update_score', d => {
            document.getElementById('score-val').innerText = d.clicks;
            document.getElementById('rank-badge').innerText = d.rank;
            
            // Emoji update live
            let idx = Math.floor(d.clicks / 500) % emojis.length;
            document.getElementById('btn-clicker').innerText = emojis[idx];
        });

        // --- CLICKER ---
        function clickAction() {
            playSound('click');
            // Animation locale imm√©diate
            let s = document.getElementById('score-val');
            s.innerText = parseInt(s.innerText) + myMult;
            
            // Effet visuel bouton
            let btn = document.getElementById('btn-clicker');
            btn.classList.remove('pulse-anim');
            void btn.offsetWidth; // trigger reflow
            btn.classList.add('pulse-anim');

            socket.emit('add_click');
        }

        function buyUpgrade() {
            socket.emit('buy_upgrade');
            // Le son 'coin' sera jou√© si succ√®s via le notif
        }

        // --- CASINO ANIMATION ---
        let spinning = false;
        function spinCasino() {
            if(spinning) return;
            let currentScore = parseInt(document.getElementById('score-val').innerText);
            if(currentScore < 500) return showToast("Pas assez d'argent !", "error");

            spinning = true;
            document.getElementById('btn-spin').disabled = true;
            document.getElementById('casino-result').innerText = "";
            socket.emit('spin_wheel');
            
            // Animation Loop
            let slots = [document.getElementById('s1'), document.getElementById('s2'), document.getElementById('s3')];
            let symbols = ["üçí", "üçã", "üçá", "üíé", "7Ô∏è‚É£"];
            
            let interval = setInterval(() => {
                slots.forEach(s => s.innerText = symbols[Math.floor(Math.random() * symbols.length)]);
                playSound('spin');
            }, 100);

            // Attente du r√©sultat
            socket.once('spin_result', d => {
                setTimeout(() => { // On laisse tourner un peu pour le suspense (1.5s)
                    clearInterval(interval);
                    spinning = false;
                    document.getElementById('btn-spin').disabled = false;

                    // Affichage r√©sultat
                    let resSym = d.outcome === 'perdu' ? ["‚ùå","‚ùå","‚ùå"] : 
                                 d.outcome === 'x2' ? ["üçí","üçí","üçí"] : 
                                 d.outcome === 'x5' ? ["üíé","üíé","üíé"] : ["üëë","üëë","üëë"];
                    
                    if(d.outcome === 'perdu') { // Perdu : on m√©lange
                         slots[0].innerText = "‚ùå"; slots[1].innerText = "üçã"; slots[2].innerText = "üçá";
                         showToast("Perdu...", "error");
                    } else {
                        slots.forEach((s, i) => s.innerText = resSym[i]);
                        playSound('win');
                        showToast(`GAGN√â ! +${d.gain}`, "success");
                    }
                }, 1500);
            });
        }

        // --- TOAST SYSTEM (Popups) ---
        function showToast(msg, type) {
            const box = document.createElement('div');
            box.className = `toast ${type}`;
            box.innerText = msg;
            document.getElementById('toast-container').appendChild(box);
            
            // Trigger animation
            setTimeout(() => box.classList.add('show'), 10);
            
            // Auto remove
            setTimeout(() => {
                box.classList.remove('show');
                setTimeout(() => box.remove(), 300);
            }, 3000);

            if(type === 'success') playSound('coin');
        }

        socket.on('notif_success', m => showToast(m, 'success'));
        socket.on('notif_error', m => showToast(m, 'error'));

        // --- NAV ---
        function switchView(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            el.classList.add('active');
        }

        socket.on('relative_lb', d => {
            const box = document.getElementById('relative-lb-box');
            box.innerHTML = d.lb.map(u => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #222; padding:4px;">
                    <span style="${u.pseudo === document.getElementById('u').value ? 'color:var(--accent)':''}">${u.pseudo}</span>
                    <span>${u.clicks}</span>
                </div>
            `).join('');
        });
    </script>
</body>
</html>
