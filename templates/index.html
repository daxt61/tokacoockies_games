<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sorek Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --border: #30363d; --accent: #58a6ff; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 250px; background: #010409; border-right: 1px solid var(--border); padding: 20px; }
        #main { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #canvas-box { background: white; border-radius: 10px; width: 100%; max-width: 700px; height: 400px; touch-action: none; }
        canvas { width: 100%; height: 100%; border-radius: 10px; cursor: crosshair; }
        #chat { width: 300px; background: #010409; border-left: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; }
        #msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        input { background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; }
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div style="background:var(--panel); padding:30px; border-radius:12px; border:1px solid var(--border); text-align:center;">
            <h2>SOREK HUB</h2>
            <input id="pseudo-in" placeholder="Pseudo..."><br><br>
            <button class="btn" onclick="start()">ENTRER</button>
        </div>
    </div>

    <div id="sidebar">
        <h3 id="my-name">...</h3>
        <div id="user-list" style="margin-top:20px"></div>
    </div>

    <div id="main">
        <h3>ðŸŽ¨ Paint Collectif</h3>
        <div id="canvas-box"><canvas id="canvas"></canvas></div>
        <button class="btn" onclick="clearC()" style="background:#f85149">Effacer</button>
    </div>

    <div id="chat">
        <div id="msgs"></div>
        <input id="chat-in" placeholder="Message...">
        <button class="btn" onclick="send()">Envoyer</button>
    </div>

    <script>
        const socket = io();
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let drawing = false, lx=0, ly=0;

        function start() {
            const p = document.getElementById('pseudo-in').value;
            if(!p) return;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('my-name').innerText = p;
            socket.emit('join', { pseudo: p });
            initP();
        }

        function send() {
            const i = document.getElementById('chat-in');
            socket.emit('msg', { m: i.value });
            i.value = "";
        }

        socket.on('new_msg', d => {
            const m = document.getElementById('msgs');
            m.innerHTML += `<div><b>${d.p}:</b> ${d.m}</div>`;
            m.scrollTop = m.scrollHeight;
        });

        socket.on('update_users', users => {
            const l = document.getElementById('user-list');
            l.innerHTML = "";
            for(let id in users) l.innerHTML += `<div>â€¢ ${users[id].pseudo}</div>`;
        });

        function initP() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            const draw = (e) => {
                if(!drawing) return;
                const r = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - r.left;
                const y = (e.clientY || e.touches[0].clientY) - r.top;
                ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(x, y); ctx.stroke();
                socket.emit('draw_data', {x1:lx, y1:ly, x2:x, y2:y});
                lx=x; ly=y;
            };
            canvas.onmousedown = (e) => { drawing=true; const r=canvas.getBoundingClientRect(); lx=e.clientX-r.left; ly=e.clientY-r.top; };
            canvas.onmousemove = draw;
            window.onmouseup = () => drawing=false;
            canvas.ontouchstart = (e) => { drawing=true; const r=canvas.getBoundingClientRect(); lx=e.touches[0].clientX-r.left; ly=e.touches[0].top; };
            canvas.ontouchmove = (e) => { e.preventDefault(); draw(e); };
            canvas.ontouchend = () => drawing=false;
        }

        socket.on('draw_remote', d => {
            ctx.beginPath(); ctx.moveTo(d.x1, d.y1); ctx.lineTo(d.x2, d.y2); ctx.stroke();
        });

        function clearC() { ctx.clearRect(0,0,canvas.width,canvas.height); socket.emit('clear_canvas'); }
        socket.on('canvas_cleared', () => ctx.clearRect(0,0,canvas.width,canvas.height));
    </script>
</body>
</html>
